{% extends "base.html" %}

{% block title %}Edit Workshop Job{% endblock %}

{% block header_title %}Edit Workshop Job{% endblock %}

{% block scripts %}
<script>
function addItemRow() {
  const container = document.getElementById("items");
  const div = document.createElement("div");
  div.className = "form-group item-row";
  div.innerHTML = `
    <label>Item:</label>
    <input type="text" name="item_name[]" class="form-control">
    <label>Qty:</label>
    <input type="number" name="qty[]" class="form-control" value="1" min="0">
    <button type="button" onclick="this.parentElement.remove()">Hapus</button>
  `;
  container.appendChild(div);
}
</script>
{% endblock %}

{% block content %}
  {% if error %}
  <div class="alert alert-danger">
    {{ error }}
  </div>
  {% endif %}

  <section>
    <form action="/workshop/edit/{{ job.id }}" method="post" class="auth-form">
      <div class="form-group">
        <label for="forklift_id">Forklift:</label>
        <select name="forklift_id" id="forklift_id" required class="form-control">
          {% for f in forklifts %}
          <option value="{{ f.id }}" {% if f.id == job.forklift_id %}selected{% endif %}>
            {{ f.brand }} - {{ f.eq_no }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label for="date">Tanggal:</label>
        <input type="date" name="date" id="date" value="{{ job.date }}" required class="form-control">
      </div>

      <div class="form-group">
        <label for="technicians">Teknisi (multi-select):</label><br>
        <select name="technicians" id="technicians" multiple size="6" class="form-control">
          {% for u in users %}
          <option value="{{ u.id }}" {% if u.id in selected_tech_ids %}selected{% endif %}>
            {{ u.name }}
          </option>
          {% endfor %}
        </select>
        <div style="font-size:12px;color:#666;margin-top:4px;">
          Tahan Ctrl/Cmd untuk memilih lebih dari satu teknisi
        </div>
      </div>

      <div class="form-group">
        <label for="report_no">Report No:</label>
        <input type="text" name="report_no" id="report_no" value="{{ job.report_no }}" required class="form-control">
      </div>

      <div class="form-group">
        <label for="job_desc">Pekerjaan:</label><br>
        <textarea name="job_desc" id="job_desc" rows="4" class="form-control" required>{{ job.job_desc }}</textarea>
      </div>

      <div class="form-group">
        <label for="notes">Notes:</label><br>
        <textarea name="notes" id="notes" rows="3" class="form-control">{{ job.notes or '' }}</textarea>
      </div>

      <h4>Item Dipakai</h4>
      <div id="items">
        {% if job.items and job.items|length > 0 %}
          {% for it in job.items %}
          <div class="form-group item-row">
            <label>Item:</label>
            <input type="text" name="item_name[]" value="{{ it.item_name }}" required class="form-control">
            <label>Qty:</label>
            <input type="number" name="qty[]" value="{{ it.qty }}" min="0" required class="form-control">
            <button type="button" onclick="this.parentElement.remove()">Hapus</button>
          </div>
          {% endfor %}
        {% else %}
          <div class="form-group item-row">
            <label>Item:</label>
            <input type="text" name="item_name[]" class="form-control">
            <label>Qty:</label>
            <input type="number" name="qty[]" class="form-control" value="1" min="0">
            <button type="button" onclick="this.parentElement.remove()">Hapus</button>
          </div>
        {% endif %}
      </div>
      <button type="button" onclick="addItemRow()">+ Tambah Item</button><br><br>

      <div class="form-actions">
        <button type="submit" class="btn">Save</button>
        <a href="/workshop/" class="btn btn-secondary">Kembali</a>
      </div>
    </form>
  </section>
{% endblock %}