{% extends "base.html" %}
{% import "macros.html" as forms %}

{% block title %}Workshop Jobs{% endblock %}

{% block head %}
{{ super() }}
{% endblock %}

{% block scripts %}
<script>
function addItemRow() {
  const container = document.getElementById("items");
  const div = document.createElement("div");
  div.className = "form-group item-row";
  div.innerHTML = `
    <label>Item:</label>
    <input type="text" name="item_name[]" class="form-control">
    <label>Qty:</label>
    <input type="text" name="qty[]" class="form-control">
    <button type="button" onclick="this.parentElement.remove()">Hapus</button>
  `;
  container.appendChild(div);
}
</script>
{% endblock %}

{% block content %}
<h1>Workshop Jobs</h1>

  {% if error %}
  <div class="alert alert-danger">
    {{ error }}
  </div>
  {% endif %}
  <form action="/workshop/tambah" method="post" class="auth-form">
    <div class="form-group">
      <label>Forklift:</label>
      <select name="forklift_id" required class="form-control">
        {% for f in forklifts %}
        <option value="{{ f.id }}" {% if form_data and form_data.forklift_id == f.id %}selected{% endif %}>{{ f.brand }} - {{ f.eq_no }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label>Tanggal:</label>
      <input type="date" name="date" value="{{ today }}" required class="form-control">
    </div>

    <div class="form-group">
      <label>Teknisi: <span class="text-danger">*</span></label>
      <div class="form-check">
        {% for u in users %}
          <div>
            <input type="checkbox" name="technicians" value="{{ u.id }}" id="tech-{{ u.id }}" class="form-check-input" {% if form_data and u.id in form_data.technicians %}checked{% endif %}> 
            <label for="tech-{{ u.id }}" class="form-check-label">{{ u.name }}</label>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="form-group">
      <label>Report No:</label>
      <input type="text" name="report_no" value="{{ form_data.report_no if form_data else '' }}" required class="form-control">
    </div>

    <div class="form-group">
      <label>Pekerjaan:</label>
      <textarea name="job_desc" rows="3" required class="form-control">{{ form_data.job_desc if form_data else '' }}</textarea>
    </div>

    <div class="form-group">
      <label>Notes:</label>
      <textarea name="notes" rows="2" class="form-control">{{ form_data.notes if form_data else '' }}</textarea>
    </div>

    <h4>Item Dipakai</h4>
    <div id="items">
      {% if form_data and form_data.item_names %}
        {% for item_name, qty in zip(form_data.item_names, form_data.qtys) %}
        <div class="form-group">
          <label>Item:</label>
          <input type="text" name="item_name[]" value="{{ item_name }}" required class="form-control">
          <label>Qty:</label>
          <input type="number" name="qty[]" value="{{ qty }}" required class="form-control">
        </div>
        {% endfor %}
      {% else %}
      <div class="form-group">
        <label>Item:</label>
        <input type="text" name="item_name[]" class="form-control">
        <label>Qty:</label>
        <input type="text" name="qty[]" class="form-control">
        <button type="button" onclick="this.parentElement.remove()">Hapus</button>
      </div>
      {% endif %}
    </div>
    <button type="button" onclick="addItemRow()">+ Tambah Item</button><br><br>

    <button type="submit" class="btn">Tambah Workshop Job</button>
  </form>

  {% if success %}
  <div class="success-message">
    Workshop job berhasil ditambahkan!
  </div>
  {% endif %}

  <h2>Daftar Workshop Jobs</h2>
  <table>
    <tr>
      <th>Report No</th>
      <th>Forklift</th>
      <th>Tanggal</th>
      <th>Teknisi</th>
      <th>Pekerjaan</th>
      <th>Notes</th>
      <th>Item Dipakai</th>
      <th>Aksi</th>
    </tr>
    {% for job in jobs %}
    <tr>
      <td>{{ job.report_no }}</td>
      <td>{{ job.forklift.brand }} ({{ job.forklift.eq_no }})</td>
      <td>{{ job.date }}</td>
      <td>
        {% for assign in job.assigned %}
          {{ assign.user.name }}<br>
        {% endfor %}
      </td>
      <td>{{ job.job_desc }}</td>
      <td>{{ job.notes or '-' }}</td>
      <td>
        {% for item in job.items %}
          {{ item.item_name }} ({{ item.qty }})<br>
        {% endfor %}
      </td>
      <td>
  {% if is_admin(request.state.user) or is_assigned_to_workshop(request.state.user, job) %}
    <a class="btn-link" href="/workshop/edit/{{ job.id }}">Edit</a> | <a href="/workshop/delete/{{ job.id }}">Delete</a>
  {% endif %}
</td>
    </tr>
    {% endfor %}
  </table>

  {{ forms.pagination_controls(pagination, "/workshop/") }}
{% endblock %}